services:
  searxng:
    image: searxng/searxng:latest
    env_file:
      - ../.env
    ports:
      - "28981:8080"
    volumes:
      - ./searxng/settings.yml:/etc/searxng/settings.yml:ro
      - ./searxng/proxy-entrypoint.sh:/opt/proxy-entrypoint.sh:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: ["/bin/sh", "/opt/proxy-entrypoint.sh"]
    restart: unless-stopped

  crawl4ai-http:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    env_file:
      - ../.env
    container_name: crawl4ai-http-bridge
    depends_on:
      - searxng
    ports:
      - "18080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      SERVER_MODE: http
      HTTP_PORT: 8080
      ENABLE_CACHE: "true"
      CACHE_TTL: 3600
      ENABLE_RATE_LIMIT: "true"
      ENABLE_MONITORING: "true"
      LOG_LEVEL: INFO
    volumes:
      - ../config.json:/app/config.json:ro
      - ../logs:/app/logs
      - ../cache:/app/cache
      - ../reports:/app/reports
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/app/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

networks:
  default:
    name: crawl4ai-network
